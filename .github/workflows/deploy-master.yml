name: Deploy adhocint.com (PM2 + rsync)

on:
  push:
    branches: [master] # change if your default branch differs

concurrency: adhocint-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install & build
        run: |
          npm ci
          npm run build

      - name: Prepare standalone bundle
        run: |
          set -e
          mkdir -p out_standalone
          # Next.js standalone server
          cp -r .next/standalone/* out_standalone/
          # Ensure target .next exists, then copy static assets
          mkdir -p out_standalone/.next
          cp -r .next/static out_standalone/.next/static
          # Optional public assets
          [ -d public ] && cp -r public out_standalone/public
          # PM2 config + placeholder uploads (symlinked on server)
          cp ecosystem.config.js out_standalone/
          mkdir -p out_standalone/uploads

      # Load deploy key safely (handles multiline keys)
      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add host key to known_hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          #SSH_PORT: ${{ secrets.SSH_PORT }} # optional
        run: |
          set -e
          HOST="$(printf '%s' "$SSH_HOST" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          if [ -n "${SSH_PORT:-}" ]; then
            KN_HOST="[${HOST}]:${SSH_PORT}"
          else
            KN_HOST="${HOST}"
          fi
          mkdir -p ~/.ssh
          ssh-keyscan -H "$KN_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Rsync upload to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          #SSH_PORT: ${{ secrets.SSH_PORT }} # optional
        run: |
          set -e
          HOST="$(printf '%s' "$SSH_HOST" | tr -d '\r\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
          [ -n "${SSH_PORT:-}" ] && SSH_OPTS="-p ${SSH_PORT}" || SSH_OPTS=""
          RSYNC_DEST="/var/www/adhocint.com/releases/${GITHUB_SHA}/"
          rsync -az --delete -e "ssh -o StrictHostKeyChecking=accept-new $SSH_OPTS" \
            out_standalone/ "${SSH_USER}@${HOST}:${RSYNC_DEST}"

      - name: Activate release & PM2 reload (zero downtime)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # port: ${{ secrets.SSH_PORT }}   # uncomment if you set SSH_PORT
          script_stop: true
          script: |
            set -euo pipefail
            # pass GITHUB_SHA from the runner into this shell
            GITHUB_SHA="${GITHUB_SHA}"

            SITE=/var/www/adhocint.com
            REL="$SITE/releases/$GITHUB_SHA"
            CUR="$SITE/current"
            SHARED="$SITE/shared"

            # link persistent env & uploads into the new release
            [ -f "$SHARED/.env" ] && ln -sfn "$SHARED/.env" "$REL/.env"
            rm -rf "$REL/uploads"
            ln -sfn "$SHARED/uploads" "$REL/uploads"

            # atomic switch
            ln -sfn "$REL" "$CUR"

            # start once; then hot reload (zero downtime)
            if pm2 describe adhocint >/dev/null 2>&1; then
              pm2 reload adhocint --update-env
            else
              pm2 start "$CUR/ecosystem.config.js"
              pm2 save
            fi
