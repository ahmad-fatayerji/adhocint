name: Deploy adhocint.com (Podman Quadlet)

on:
  push:
    branches: [master]
  workflow_dispatch:

concurrency: adhocint-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (Podman Quadlet)
        uses: appleboy/ssh-action@v1.2.0
        env:
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          APP_PORT: ${{ secrets.APP_PORT }}
          AUTH_SESSION_SECRET: ${{ secrets.AUTH_SESSION_SECRET }}
          OTP_PEPPER: ${{ secrets.OTP_PEPPER }}
          ADMIN_SESSION_COOKIE: ${{ secrets.ADMIN_SESSION_COOKIE }}
          ADMIN_SESSION_TTL_DAYS: ${{ secrets.ADMIN_SESSION_TTL_DAYS }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          CONTACT_TO: ${{ secrets.CONTACT_TO }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MINIO_BUCKET: ${{ secrets.MINIO_BUCKET }}
          MINIO_PORT: ${{ secrets.MINIO_PORT }}
          MINIO_CONSOLE_PORT: ${{ secrets.MINIO_CONSOLE_PORT }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          envs: NEXT_PUBLIC_GA_MEASUREMENT_ID,APP_PORT,AUTH_SESSION_SECRET,OTP_PEPPER,ADMIN_SESSION_COOKIE,ADMIN_SESSION_TTL_DAYS,EMAIL_HOST,EMAIL_PORT,EMAIL_USER,EMAIL_PASS,EMAIL_FROM,CONTACT_TO,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,MINIO_ROOT_USER,MINIO_ROOT_PASSWORD,MINIO_BUCKET,MINIO_PORT,MINIO_CONSOLE_PORT,SUPER_ADMIN_EMAIL,SUPER_ADMIN_PASSWORD
          script: |
            set -euo pipefail

            APP_DIR=/opt/adhocint
            SHARED="$APP_DIR/shared"

            # Ensure repo exists (bootstrap safety)
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "ERROR: $APP_DIR is missing a git repo. Clone it once on the server."
              exit 1
            fi

            # Ensure shared env exists (written every deploy)
            mkdir -p "$SHARED"
            umask 077
            if command -v python3 >/dev/null 2>&1; then
              ENC_PG_PASS="$(python3 - <<'PY'
import os
import urllib.parse
print(urllib.parse.quote(os.environ["POSTGRES_PASSWORD"]))
PY
)"
            else
              ENC_PG_PASS="${POSTGRES_PASSWORD//@/%40}"
            fi
            MINIO_PORT="${MINIO_PORT:-9000}"
            DATABASE_URL="postgresql://${POSTGRES_USER}:${ENC_PG_PASS}@adhocint-db:5432/${POSTGRES_DB}"
            MINIO_ENDPOINT="http://adhocint-minio:${MINIO_PORT}"
            MINIO_ACCESS_KEY="${MINIO_ROOT_USER}"
            MINIO_SECRET_KEY="${MINIO_ROOT_PASSWORD}"
            cat > "$SHARED/.env.production" <<EOF
            NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID}      
            APP_PORT=${APP_PORT}
            PORT=${APP_PORT}
            AUTH_SESSION_SECRET=${AUTH_SESSION_SECRET}
            OTP_PEPPER=${OTP_PEPPER}
            ADMIN_SESSION_COOKIE=${ADMIN_SESSION_COOKIE}
            ADMIN_SESSION_TTL_DAYS=${ADMIN_SESSION_TTL_DAYS}
            EMAIL_HOST=${EMAIL_HOST}
            EMAIL_PORT=${EMAIL_PORT}
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASS=${EMAIL_PASS}
            EMAIL_FROM=${EMAIL_FROM}
            CONTACT_TO=${CONTACT_TO}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=${POSTGRES_DB}
            DATABASE_URL=${DATABASE_URL}
            MINIO_ROOT_USER=${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            MINIO_BUCKET=${MINIO_BUCKET}
            MINIO_PORT=${MINIO_PORT}
            MINIO_CONSOLE_PORT=${MINIO_CONSOLE_PORT}
            MINIO_ENDPOINT=${MINIO_ENDPOINT}
            MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY}
            MINIO_SECRET_KEY=${MINIO_SECRET_KEY}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            EOF

            cd "$APP_DIR"

            # Make ops scripts executable (Windows/Git perms safety)
            chmod +x ops/*.sh || true

            # Ensure git can operate even if ownership changed at some point
            git config --global --add safe.directory "$APP_DIR" || true

            # Ensure user systemd bus is reachable in non-interactive SSH
            export XDG_RUNTIME_DIR="/run/user/$(id -u)"
            export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"

            # Ensure quadlet units are installed where systemd-user reads them
            mkdir -p "$HOME/.config/containers/systemd"
            cp -f ops/quadlet/*.container "$HOME/.config/containers/systemd/" || true

            # Run deployment (pull, build, migrations, etc.)
            GIT_PULL=1 ops/podman-quadlet-deploy.sh

            # Optional: show status at end (helps Actions logs)
            systemctl --user daemon-reload || true
            systemctl --user status adhocint-db adhocint-minio adhocint-web --no-pager || true
