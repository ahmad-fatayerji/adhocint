name: Deploy adhocint.com (Podman Quadlet)

on:
  push:
    branches: [master]

concurrency: adhocint-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (Podman Quadlet)
        uses: appleboy/ssh-action@v1.2.0
        env:
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          APP_PORT: ${{ secrets.APP_PORT }}
          AUTH_SESSION_SECRET: ${{ secrets.AUTH_SESSION_SECRET }}
          OTP_PEPPER: ${{ secrets.OTP_PEPPER }}
          ADMIN_SESSION_COOKIE: ${{ secrets.ADMIN_SESSION_COOKIE }}
          ADMIN_SESSION_TTL_DAYS: ${{ secrets.ADMIN_SESSION_TTL_DAYS }}
          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          CONTACT_TO: ${{ secrets.CONTACT_TO }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
          MINIO_BUCKET: ${{ secrets.MINIO_BUCKET }}
          MINIO_PORT: ${{ secrets.MINIO_PORT }}
          MINIO_CONSOLE_PORT: ${{ secrets.MINIO_CONSOLE_PORT }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
          SUPER_ADMIN_PASSWORD: ${{ secrets.SUPER_ADMIN_PASSWORD }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          envs: NEXT_PUBLIC_GA_MEASUREMENT_ID,APP_PORT,AUTH_SESSION_SECRET,OTP_PEPPER,ADMIN_SESSION_COOKIE,ADMIN_SESSION_TTL_DAYS,EMAIL_HOST,EMAIL_PORT,EMAIL_USER,EMAIL_PASS,EMAIL_FROM,CONTACT_TO,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB,MINIO_ROOT_USER,MINIO_ROOT_PASSWORD,MINIO_BUCKET,MINIO_PORT,MINIO_CONSOLE_PORT,SUPER_ADMIN_EMAIL,SUPER_ADMIN_PASSWORD
          script: |
            set -euo pipefail
            APP_DIR=/opt/adhocint
            SHARED="$APP_DIR/shared"
            mkdir -p "$SHARED"
            umask 077
            cat > "$SHARED/.env.production" <<EOF
            NEXT_PUBLIC_GA_MEASUREMENT_ID=${NEXT_PUBLIC_GA_MEASUREMENT_ID}
            APP_PORT=${APP_PORT}
            PORT=${APP_PORT}
            AUTH_SESSION_SECRET=${AUTH_SESSION_SECRET}
            OTP_PEPPER=${OTP_PEPPER}
            ADMIN_SESSION_COOKIE=${ADMIN_SESSION_COOKIE}
            ADMIN_SESSION_TTL_DAYS=${ADMIN_SESSION_TTL_DAYS}
            EMAIL_HOST=${EMAIL_HOST}
            EMAIL_PORT=${EMAIL_PORT}
            EMAIL_USER=${EMAIL_USER}
            EMAIL_PASS=${EMAIL_PASS}
            EMAIL_FROM=${EMAIL_FROM}
            CONTACT_TO=${CONTACT_TO}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=${POSTGRES_DB}
            MINIO_ROOT_USER=${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
            MINIO_BUCKET=${MINIO_BUCKET}
            MINIO_PORT=${MINIO_PORT}
            MINIO_CONSOLE_PORT=${MINIO_CONSOLE_PORT}
            SUPER_ADMIN_EMAIL=${SUPER_ADMIN_EMAIL}
            SUPER_ADMIN_PASSWORD=${SUPER_ADMIN_PASSWORD}
            EOF

            cd "$APP_DIR"
            GIT_PULL=1 ops/podman-quadlet-deploy.sh
